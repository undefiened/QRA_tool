(()=>{"use strict";class e{#e;#t;#i;#s;#n;#o;#r;#a;#l;#d;#h;#u;#p;#g;#c;#m;#y;#f;constructor(e,t,i){return this.#e=t,this.#t=!1,this.#i=null,this.#s=!1,this.#n=null,this.#o=!0,this.#r=L.marker(e,{draggable:!0,autoPan:!0}),this.#a=i,this.#l=[],this.#u=0,this.#r.on("moveend",this.#L.bind(this)),this.#g=this.#C(),this.#r.bindPopup(this.#g),this.#b(),this.#S(),this}#S(){this.#d=turf.circle(Object.values(this.#r.getLatLng()).toReversed(),this.#e/2,{units:"meters"}),this.#h=Math.PI*(this.#e/2)**2}#b(){this.#p=turf.point(Object.values(this.#r.getLatLng()).toReversed())}#C(){let e=document.createElement("popup-div"),t=document.createElement("p");t.innerHTML="Altitude",this.#m=document.createElement("slider-div"),this.#f=document.createElement("button"),this.#y=document.createElement("button"),this.#c=document.createElement("input");let i=document.createElement("label"),s=document.createElement("div");e.style.display="flex",e.style.flexDirection="column",this.#m.id="slider",this.#m.style.width="200px",noUiSlider.create(this.#m,{start:[this.#e],step:1,tooltips:{to:e=>Math.round(e)},connect:"lower",range:{min:10,max:1200}}),e.appendChild(this.#m),this.#m.noUiSlider.on("change",this.#E.bind(this)),e.appendChild(t),this.#y.innerHTML="Split segment",this.#y.style.color="BlueViolet",this.#y.style.background="white",this.#y.style.borderRadius="6px",e.appendChild(this.#y),e.appendChild(document.createElement("br")),this.#f.innerHTML="Remove waypoint",this.#f.style.color="Tomato",this.#f.style.background="white",this.#f.style.borderRadius="6px",e.appendChild(this.#f),e.appendChild(document.createElement("br")),this.#c.type="checkbox",this.#c.name="smooth",this.#c.checked=!0,i.innerHTML="Smooth altitude change";let n=document.createElement("i");n.className="fa-regular fa-circle-question",n.setAttribute("data-bs-toggle","tooltip"),n.setAttribute("title","Emulate how drone smoothly changes the altitude between two waypoints with the rate of 90 m altitude change per 1km of horizontal distance. When disabled, a sharp transition occurs."),new bootstrap.Tooltip(n);let o=document.createElement("sup");return o.appendChild(n),i.appendChild(o),i.for="smooth",i.style.paddingRight="10px",this.#c.addEventListener("change",this.#A.bind(this)),s.style.color="blue",i.style.color="black",s.appendChild(i),s.appendChild(this.#c),e.appendChild(s),e}#L(e){this.#r=e.target,this.#S(),this.#b();for(let e of this.#l)e.update()}#E(e,t){this.#e=Math.floor(e[t]),this.#S(),this.#t&&(this.#i.altitude=this.#e,this.#i.altitudeManuallyChanged=!0,this.#i.update()),this.#l.length>0&&this.#l[0].nodesList[0].isSmooth&&this.#l[0].update()}#A(e){this.#t&&(this.#o=0==this.#o,this.#i.update())}hasEdge(){return this.#t}hasNextCicle(){return this.#s}altitudeUpdatedGlobally(e){this.#e=e,this.#m.noUiSlider.set(e),this.#S()}get altitude(){return this.#e}get nextCicle(){return this.#n}get isSmooth(){return this.#o}get marker(){return this.#r}get splitButtonElement(){return this.#y}get removeButtonElement(){return this.#f}get smoothCheckboxElement(){return this.#c}get sliderElement(){return this.#m}get circle(){return this.#d}get circleArea(){return this.#h}get circleCoveredPopulation(){return this.#u}get point(){return this.#p}get edge(){return this.#i}get edgesList(){return this.#l}get positionInList(){return this.#a}set edge(e){this.#i=e,this.#t=!!e}set nextCicle(e){this.#n=e,this.#s=!!e}set positionInList(e){this.#a=e}set circleCoveredPopulation(e){this.#u=e}}class t{#e;#M;#x;#N;#B;#_;#v;#D;#k;#U;#a;#P;#w;#F;#T;#I;#R;#G;#J;#O;#q;#z;#H;#j;#W;constructor(e,t,i,s,n){this.#e=i,this.#M=s,this.#B=0,this.#N=0,this.#_=[],this.#v=0,this.#D=0,this.#k=0,this.#U=0,this.#G=8.34,this.#a=n,this.#J=0,this.#O=0,this.#q=0,this.#H=[e,t],this.#j=0,this.#W=!1,this.#V()}#V(){let[e,t]=this.#H,[i,s]=[Object.values(e.marker.getLatLng()),Object.values(t.marker.getLatLng())];this.#w="#0d6efd",this.#P=new L.Polyline([i,s],{color:this.#w,weight:20,opacity:.9,smoothFactor:1}),e.edge=this,e.edgesList.push(this),t.edgesList.push(this),this.#Y()}#X(t,i){let s=turf.bearing(t.point,i.point),n=turf.destination(i.point,this.#j,s,{units:"meters"});return new e(n.geometry.coordinates.toReversed(),i.altitude,-1)}#Y(){let[e,t]=this.#H;this.#q=turf.distance(e.point,t.point,{units:"meters"});let i=null;this.#j>0&&(i=this.#X(e,t));let s=[Object.values(e.marker.getLatLng()),Object.values(t.marker.getLatLng())];!(this.#j>0)||(s[1]=Object.values(i.marker.getLatLng())),this.#P.setLatLngs(s),this.#I=turf.buffer(this.#P.toGeoJSON(),this.#M,{units:"meters"}),this.#R=turf.area(this.#I,{units:"meters"});let n=Math.abs(t.altitude-e.altitude)/90*1e3,o=this.#q>=n&&t.altitude!=e.altitude;if(e.isSmooth&&o){let s=(this.#q-n)/this.#q,o=this.#Z(s),r=L.polygon(o.map((function(e){return e.geometry.coordinates.toReversed()})),{color:"purple",weight:6,opacity:.5,smoothFactor:1}),a=turf.union(e.circle,r.toGeoJSON()),l=this.#j>0?i:t,d=turf.union(a,l.circle),h=.001;this.#T=turf.buffer(d,h,{units:"meters"})}else this.#T=turf.buffer(this.#P.toGeoJSON(),this.#e/2,{units:"meters"});this.#O=turf.area(this.#T,{units:"meters"}),this.#q+=this.#j}#Z(e){let[t,i]=this.#H,s=null,[n,o]=[t.point,i.point],r=turf.bearing(n,o),a=turf.destination(n,t.altitude/2,(r+90)%180,{units:"meters"}),l=turf.destination(n,-t.altitude/2,(r+90)%180,{units:"meters"}),d=turf.destination(o,i.altitude/2,(r+90)%180,{units:"meters"}),h=turf.destination(o,-i.altitude/2,(r+90)%180,{units:"meters"}),u=turf.destination(a,this.#q*e,r,{units:"meters"}),p=turf.destination(l,this.#q*e,r,{units:"meters"});return this.#j>0?(s=this.#X(t,i),[a,u,d,turf.destination(d,this.#j,r,{units:"meters"}),turf.destination(h,this.#j,r,{units:"meters"}),h,p,l]):[a,u,d,h,p,l]}#$(e,t,i){let s=2*this.#M**2*e*Math.sqrt(this.#G**2+t**2)/(this.#M*this.#R)*i;this.#N=this.#q/this.#G*s,this.#x=60*s*60*1e6}update(){this.#Y()}computeNMAC_rate(e,t,i){this.#$(e,t,i)}computeFirstPartyNMAC_rate(e,t,i){let s=Math.sqrt(2*t**2),n=2*this.#M**2*e*s/(this.#M*this.#R)*i;this.#U=this.#q/t*n,this.#k=60*n*60*1e6}get population(){return this.#J}get length(){return this.#q}get groundArea(){return this.#O}get airBufferArea(){return this.#R}get polyline(){return this.#P}get polylineColor(){return this.#w}set polylineColor(e){this.#w=e,this.#P.setStyle({color:e})}get groundBuffer(){return this.#T}get airBuffer(){return this.#I}get nodesList(){return this.#H}get altitude(){return this.#e}get NMAC_radius(){return this.#M}get NMAC_rate(){return this.#x}get expectedNMAC(){return this.#N}get NMAC_time(){return this.#B}get NMAC_avg_speeds(){return this.#_}get maxSquarePopulationDensity(){return this.#v}get firstPartyDn(){return this.#D}get firstPartyNMAC_rate(){return this.#k}get expectedFirstPartyNMAC(){return this.#U}get positionInList(){return this.#a}get extraLength(){return this.#j}get altitudeManuallyChanged(){return this.#W}set population(e){this.#J=e}set altitude(e){this.#e=e}set positionInList(e){this.#a=e}set NMAC_radius(e){this.#M=e}set NMAC_time(e){this.#B=e}set NMAC_avg_speeds(e){this.#_=e}set maxSquarePopulationDensity(e){this.#v=e}set extraLength(e){this.#j=e}set v_UA(e){this.#G=e}set altitudeManuallyChanged(e){this.#W=e}set firstPartyDn(e){this.#D=e}}function i(e){let t=e.properties.B;return 0===t||null==t?{fillOpacity:0,weight:0,opacity:0}:{fillColor:(i=t,i>500?"#800026":i>300?"#BD0026":i>200?"#E31A1C":i>100?"#FC4E2A":i>50?"#FD8D3C":i>20?"#FEB24C":i>10||i>-10?"#FED976":"#FFEDA0"),weight:0,opacity:1,color:"CadetBlue",dashArray:"10",fillOpacity:.5};var i}function s(e){let t=e.properties.T;return 0===t||null==t?{fillOpacity:0,weight:0,opacity:0}:{fillColor:(i=t,i>.01?"#000033":i>.005?"#000066":i>.001?"#000099":i>5e-4?"#0000CC":i>1e-4?"#0033FF":i>5e-5?"#0099FF":i>1e-5?"#00CCFF":i>-10?"#00FFCC":"#FFEDA0"),weight:0,opacity:1,color:"CadetBlue",dashArray:"10",fillOpacity:.5};var i}function n(e){let t=e.properties.Dn;return 0===t||null==t?{fillOpacity:0,weight:0,opacity:0}:{fillColor:(i=t,i>.05?"#004d00":i>.01?"#006600":i>.005?"#008000":i>.001?"#00b300":i>5e-4?"#00cc00":i>1e-4?"#00e600":i>1e-5?"#33ff33":i>0?"#99ff99":"#FFEDA0"),weight:0,opacity:1,color:"CadetBlue",dashArray:"10",fillOpacity:.5};var i}function o(){return{color:"black",weight:1,opacity:.95}}function r(){return{color:"black",weight:1,opacity:.95}}function a(e,t){let i=[];for(let s of e){let e=turf.bbox(s),n={minX:e[0],minY:e[1],maxX:e[2],maxY:e[3]},o=t.search(n).map((e=>e.id));i=i.concat(o)}return i}let l=window["polyclip-ts"],d={nk_area:"./data/population_nk_processed_06w2_with_D.geojson",stockholm_area:"./data/population_stockholm.geojson",ockero_area:"./data/population_ockero.geojson",vastervik_area:"./data/population_vastervik.geojson"},h={nk_area:[58.5877,16.1924],stockholm_area:[59.3118,18.0663],ockero_area:[57.71,11.65],vastervik_area:[57.75,16.63]},u={nk_area:12,stockholm_area:11,ockero_area:12,vastervik_area:12};const p="Ground risk",g="Air risk",c='1st-party risk <span style="color: red; font-weight: bold;">(experimental)</span>';class m{static#K=1e-9;#Q;#H;#l;#ee;#te;#ie;#se;#ne;#oe;#re;#ae;#le;#de;#he;#ue;#M;#pe;#G;#ge;#ce;#me;#ye;#fe;#Le;#Ce;#be;#Se;#Ee;#Ae;#Me;#xe;#Ne;#Be;#_e;#ve;#De;#ke;#Ue;#Pe;#we;#Fe;#Te;#Ie;#Re;#Ge;#Je;#Oe;#J;#qe;#ze;#He;#je;#We;#Ve;#Ye;constructor(e){this.#We=e,this.#Ve=d[e]??d.nk_area,console.log(this.#Ve),this.#Q=200,this.#H=[],this.#l=[],this.#ee=L.layerGroup([]),this.#te=L.layerGroup([]),this.#se=null,this.#ne=null,this.#oe=L.layerGroup([]),this.#re=null,this.#ae=null,this.#le=L.layerGroup([]),this.#de=0,this.#he=0,this.#ue=0,this.#M=50,this.#pe=100,this.#G=8.34,this.#Ue=1,this.#Je=.1,this.#Fe=1,this.#Oe=1e3,this.#Ie=0,this.#Re=0,this.#Ge=0,this.#ge=document.getElementById("population"),this.#ce=document.getElementById("length"),this.#me=document.getElementById("area"),this.#ye=document.getElementById("exposed-density"),this.#fe=document.getElementById("exposed-length-weight"),this.#Le=document.getElementById("nmac-rate"),this.#Ce=document.getElementById("totals-table"),this.#be=document.getElementById("segments-table"),this.#Se=document.getElementById("segments-table-container"),this.#Ee=document.getElementById("toggle-segments-table"),this.#Ae=!1,this.#Me=document.getElementById("segment-extension"),this.#xe=document.getElementById("spinner-container"),this.#J=null,this.#qe=null,this.#ze=0,this.#He=!0,this.#je=null,this.#Ye=!1,document.getElementById("currentYear").textContent=(new Date).getFullYear(),this.#Xe(),this.#Ze(),this.#$e(),this.#Ke(),this.#Qe(),this.#et(),this.#tt(),this.#it(),this.#st(),this.#nt(),this.#ot(),this.#rt(),this.#at(),this.#lt(),this.#dt()}#ht(e){}async#Xe(){let e=new Promise(((e,t)=>{$.getJSON(this.#Ve,(function(i,s,n){"success"===s?e(i):t(error)}))}));try{this.#J=await e}catch(e){console.error("Error fetching data:",e)}if(this.#He)try{this.#je=function(e){let t=new RBush,i=e.map(((e,t)=>{let i=e.geometry.coordinates[0][0];return{minX:i[0][0],minY:i[3][1],maxX:i[2][0],maxY:i[1][1],id:t}}));return t.load(i),t}(this.#J.features)}catch(e){console.error("Error creating R-Tree of the data:",e)}this.#Ge=this.#J.features.reduce(((e,t)=>e+(t.properties.Dn||0)),0),console.log("Total Dn sum:",this.#Ge),this.#ut()}#ut(){this.#Ye=this.#J.features.some((e=>e.properties.hasOwnProperty("Dn"))),console.log("Has first-party data:",this.#Ye),this.#Ye?this.#pt():this.#gt()}#gt(){const e=document.getElementById("first-party-risk-tab");e&&(e.disabled=!0,e.classList.add("disabled"),e.style.opacity="0.5",e.style.cursor="not-allowed");const t=document.getElementById("first-party-label-totals"),i=document.getElementById("first-party-label-segments");t&&(t.textContent="N/A for this area"),i&&(i.textContent="N/A for this area"),[...document.querySelectorAll("#totals-table-header .table-success"),...document.querySelectorAll("#totals-table tbody .table-success")].forEach((e=>{e.style.opacity="0.5",e.style.cursor="not-allowed",e.title="1st-party risk data not available for this area"})),[...document.querySelectorAll("#segment-totals-table-header .table-success"),...document.querySelectorAll("#segments-table tbody .table-success")].forEach((e=>{e.style.opacity="0.5",e.style.cursor="not-allowed",e.title="1st-party risk data not available for this area"}))}#pt(){const e=document.getElementById("first-party-risk-tab");e&&(e.disabled=!1,e.classList.remove("disabled"),e.style.opacity="1",e.style.cursor="pointer");const t=document.getElementById("first-party-label-totals"),i=document.getElementById("first-party-label-segments");t&&(t.textContent="(experimental)"),i&&(i.textContent="(experimental)"),[...document.querySelectorAll("#totals-table-header .table-success"),...document.querySelectorAll("#totals-table tbody .table-success")].forEach((e=>{e.style.opacity="1",e.style.cursor="default",e.title=""})),[...document.querySelectorAll("#segment-totals-table-header .table-success"),...document.querySelectorAll("#segments-table tbody .table-success")].forEach((e=>{e.style.opacity="1",e.style.cursor="default",e.title=""}))}async#Ze(){await this.#Xe();let e=L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:20,attribution:'&copy <a href="http://openstreetmap.org">OpenStreetMap</a> &copy; <a href="https://www.lantmateriet.se/en/">Lantmäteriet</a>'}),t=L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:20,attribution:'&copy <a href="http://openstreetmap.org">OpenStreetMap</a> &copy; <a href="https://www.lantmateriet.se/en/">Lantmäteriet</a>'}),o=L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:20,attribution:'&copy <a href="http://openstreetmap.org">OpenStreetMap</a> &copy; <a href="https://www.lantmateriet.se/en/">Lantmäteriet</a>'});this.#ie=L.map("map",{doubleClickZoom:!1,preferCanvas:!0,layers:[e]}).setView(h[this.#We],u[this.#We]);let r={[p]:e,[g]:t};this.#Ye&&(r[c]=o),L.control.layers(r,null,{collapsed:!1}).addTo(this.#ie);let a=L.geoJSON(this.#J,{style:i}).addTo(this.#ie),l=L.geoJSON(this.#J,{style:s}),d=L.geoJSON(this.#J,{style:n});this.#oe.addTo(this.#ie),this.#ee.addTo(this.#ie),this.#te.addTo(this.#ie),this.#ie.on("baselayerchange",function(e){a.remove(),l.remove(),this.#Ye&&d.remove(),this.#oe.remove(),this.#le.remove(),this.#te.remove(),e.name===p?(a.addTo(this.#ie),this.#oe.addTo(this.#ie)):e.name===g?(l.addTo(this.#ie),this.#le.addTo(this.#ie)):e.name===c&&this.#Ye&&(d.addTo(this.#ie),this.#oe.addTo(this.#ie)),this.#te.addTo(this.#ie)}.bind(this)),this.#ie.on("dblclick",this.#ct.bind(this))}deinitializeMap(){null!=this.#ie&&this.#ie.remove()}#$e(){[].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]')).map((function(e){return new bootstrap.Tooltip(e)}))}#ct(i){let s=this.#H.length>0?this.#H[this.#H.length-1].altitude:this.#Q,n=Object.values(i.latlng);const o=new e(n,s,this.#H.length);if(this.#ee.addLayer(o.marker),this.#mt(o),this.#H.length>0&&(this.#H[this.#H.length-1].nextCicle=o),this.#H.push(o),this.#H.length>1){let[e,i]=this.#H.slice(this.#H.length-2,this.#H.length),s=new t(e,i,e.altitude,this.#M,this.#l.length);this.#Me.checked&&(s.extraLength=this.#pe,s.update()),this.#te.addLayer(s.polyline),this.#l.push(s),this.#yt("ground"),this.#yt("air"),this.#ft([s])}}#mt(e){e.smoothCheckboxElement.addEventListener("change",(t=>{e.hasEdge()&&(this.#yt("ground"),this.#ft([e.edge]))})),e.sliderElement.noUiSlider.on("change",((t,i)=>{this.#yt("ground"),e.hasEdge()&&2===e.edgesList.length&&e.edgesList[0].nodesList[0].isSmooth||!e.hasEdge()&&1===e.edgesList.length&&e.edgesList[0].nodesList[0].isSmooth?this.#ft(e.edgesList):e.hasEdge()&&this.#ft([e.edge])})),e.splitButtonElement.addEventListener("click",(()=>{this.#Lt(e)})),e.removeButtonElement.addEventListener("click",(()=>{this.#Ct(e)})),e.marker.on("moveend",(t=>{this.#yt("ground"),this.#yt("air"),this.#ft(e.edgesList)}))}#Lt(i){if(i.hasEdge()){let s=Object.values(i.edge.polyline.getCenter()),n=new e(s,i.altitude,i.positionInList+1),o=null,r=i.edge.nodesList[1];this.#ee.addLayer(n.marker),this.#mt(n),i.nextCicle=n,n.nextCicle=r,this.#H.splice(i.positionInList+1,0,n),i.edge.nodesList[1]=n,n.edgesList[0]=i.edge,i.edge.update(),1===r.edgesList.length?(r.edgesList.pop(),o=new t(n,r,n.altitude,this.#M,i.edge.positionInList+1)):2===r.edgesList.length&&(o=new t(n,r,n.altitude,this.#M,i.edge.positionInList+1),r.edgesList.reverse(),r.edgesList.pop()),this.#te.addLayer(o.polyline),this.#l.splice(i.edge.positionInList+1,0,o),this.#yt("ground"),this.#yt("air"),this.#ft([i.edge,o]),this.#H.slice(i.positionInList+2,this.#H.length).map((e=>{e.positionInList+=1})),this.#l.slice(i.edge.positionInList+2,this.#l.length).map((e=>{e.positionInList+=1})),this.#l.slice(i.edge.positionInList,this.#l.length).map((e=>{this.#bt(e)}))}}#Ct(e){if(e.hasEdge()&&1===e.edgesList.length)this.#H.splice(0,1),this.#ee.removeLayer(e.marker),this.#l.splice(0,1),this.#te.removeLayer(e.edge.polyline),this.#H[0].edgesList.splice(0,1),this.#H.map((e=>{e.positionInList-=1})),this.#l.map((e=>{e.positionInList-=1})),this.#be.querySelector("tbody").deleteRow(0),this.#yt("ground"),this.#yt("air"),this.#St([]),this.#l.map((e=>{this.#bt(e)}));else if(e.hasEdge()||1!==e.edgesList.length){if(2===e.edgesList.length){this.#H.splice(e.positionInList,1),this.#ee.removeLayer(e.marker),this.#l.splice(e.edge.positionInList,1),this.#te.removeLayer(e.edge.polyline),this.#be.querySelector("tbody").deleteRow(e.edge.positionInList);let t=e.edgesList[0].nodesList[0],i=e.edge.nodesList[1];t.nextCycle=i,t.edge.nodesList[1]=i,i.edgesList[0]=t.edge,t.edge.update(),this.#H.slice(e.positionInList,this.#H.length).map((e=>{e.positionInList-=1})),this.#l.slice(e.edge.positionInList,this.#l.length).map((e=>{e.positionInList-=1})),this.#yt("ground"),this.#yt("air"),this.#ft([t.edge]),this.#l.slice(e.edge.positionInList,this.#l.length).map((e=>{this.#bt(e)}))}}else{this.#H.splice(this.#H.length-1,1),this.#ee.removeLayer(e.marker),this.#l.splice(this.#l.length-1,1);let t=e.edgesList[0].nodesList[0];t.edge.polyline.remove(),t.edgesList.pop(),t.edge=null,t.nextCycle=null,this.#be.querySelector("tbody").deleteRow(this.#l.length),this.#yt("ground"),this.#yt("air"),this.#St([])}}#yt(e){"ground"===e&&null!=this.#ne?this.#oe.removeLayer(this.#ne):"air"===e&&null!=this.#ae&&this.#le.removeLayer(this.#ae);let t=this.#l.map((t=>"ground"===e?t.groundBuffer:t.airBuffer)),i=this.#Et(t);"ground"===e?(this.#se=i,this.#ne=L.geoJSON(i,{style:o}),this.#oe.addLayer(this.#ne)):"air"===e&&(this.#re=i,this.#ae=L.geoJSON(i,{style:r}),this.#le.addLayer(this.#ae))}#Et(e){let t=this.#H.map((e=>Object.values(e.point.geometry.coordinates.toReversed())));if(console.log("nodesCoordinates: ",JSON.stringify(t,null,2)),this.#l.length>0){let t=l.union(...e.map((e=>e.geometry.coordinates)));return turf.buffer(turf.multiPolygon(t),1e-4,{units:"meters"})}return null}#St(e){clearTimeout(this.#qe),this.#qe=setTimeout((()=>{this.#ft(e)}),1e3)}async#ft(e){if(await this.#Xe(),this.#se){this.#ze<1&&this.#At(),this.#ze++,this.#de=0,e.map((e=>{e.population=0}));let t=null;if(this.#He){let i=a(e.map((e=>e.groundBuffer)),this.#je),s=a(e.map((e=>e.airBuffer)),this.#je);t=Array.from(new Set(i.concat(s))).map((e=>this.#J.features[e]))}else t=this.#J.features;let i=t.length>1e3?4:1,s=Math.ceil(t.length/i),n=[],o=[],r=[],l=[],d=[],h=[],u=[],p=1e4;for(let a=0;a<i;a++){let g=a*s,c=g+s,m=t.slice(g,c),y=new Worker("./src/workers.js"),f=e.map((e=>e.groundBuffer)),L=e.map((e=>e.airBuffer)),C=e.map((e=>{let[t,i]=e.nodesList;return[t.circleCoveredPopulation,i.circleCoveredPopulation]=[0,0],[t.circle,i.circle]}));y.postMessage([m,f,L,C,p]),y.onmessage=function(t){let[s,a,g,c,m,y]=t.data;if(o.push(s),r.push(a),l.push(g),d.push(c),h.push(m),u.push(y),o.length===i){for(let t=0;t<e.length;t++){let i=e[t];i.population=o.map((e=>e[t])).reduce(((e,t)=>e+t),0),i.maxSquarePopulationDensity=Math.max(...h.map((e=>e[t])))/p;let s=r.map((e=>e[t])),n=s.reduce(((e,t)=>e.map(((e,i)=>e+t[i])))),[a,g]=i.nodesList;a.circleCoveredPopulation=n[0],g.circleCoveredPopulation=n[1];let c=l.map((e=>e[t])).reduce(((e,t)=>e+t),0);i.NMAC_time=c;let m=d.map((e=>e[t]));m=m.flat().filter((e=>e>0)),i.NMAC_avg_speeds=m;let y=m.reduce(((e,t)=>e+t),0)/m.length||0,f=this.#J.features[0].properties.p;i.computeNMAC_rate(c,y,f);let L=u.map((e=>e[t])).reduce(((e,t)=>e+t),0),C=this.#Ge>0?L/this.#Ge:0;i.firstPartyDn=C,i.computeFirstPartyNMAC_rate(C*this.#Ue,this.#G,f)}let t=this.#l.reduce((function(e,t){return e.concat(t.NMAC_avg_speeds)}),[]).flat(),i=t.length>0?t.reduce(((e,t)=>e+t),0)/t.length:0,s=this.#l.reduce(((e,t)=>e+t.airBufferArea),0),a=this.#l.reduce(((e,t)=>e+t.NMAC_time),0),g=2*this.#M**2*a*Math.sqrt(this.#G**2+i**2)/(this.#M*s)*this.#J.features[0].properties.p,c=this.#l.reduce(((e,t)=>e+t.length),0);this.#he=c/this.#G*g,this.#ue=c/this.#G,this.#de=Math.ceil(3600*g*1e6);let m=this.#l.reduce(((e,t)=>e+(t.firstPartyDn||0)),0),y=2*this.#M**2*m*this.#Ue*Math.sqrt(2*this.#G**2)/(this.#M*s)*this.#J.features[0].properties.p;this.#Re=c/this.#G*y,this.#Ie=Math.ceil(3600*y*1e6),this.#ze--,this.#dt(),e.map((e=>{this.#bt(e)})),n.forEach((function(e){e.terminate()}))}}.bind(this),n.push(y)}}}#At(){this.#xe.style.display="block";let e=this.#Ce.querySelector("tbody").querySelector("tr").querySelectorAll("td");for(let t of e)t.innerHTML='<div class="spinner-grow spinner-grow-sm text-primary" role="status"></div>'}#Mt(){this.#xe.style.display="none"}#xt(){let e=0,t=0;for(let i=0;i<this.#l.length-1;i++){let s=this.#l[i],n=this.#l[i+1];e+=Math.min(s.nodesList[1].circleCoveredPopulation,n.nodesList[0].circleCoveredPopulation),t+=Math.min(s.nodesList[1].circleArea,n.nodesList[0].circleArea)}return[e,t]}#dt(){let e=this.#l.reduce(((e,t)=>e+t.population),0),t=this.#l.reduce(((e,t)=>e+t.length),0),i=this.#l.reduce(((e,t)=>e+t.groundArea),0),[s,n]=this.#xt();e-=s,i-=n;let o=this.#Nt(),r=o.toExponential(2),a=i?(e/i).toExponential(2):0,l=this.#l.reduce(((e,t)=>Math.max(e,t.maxSquarePopulationDensity)),0),d=i?this.#he.toExponential(2):0,h=i?this.#Re.toExponential(2):0,u=this.#ue,p=this.#Ce.querySelector("tbody").querySelector("tr").querySelectorAll("td"),g=[Math.ceil(t),Math.ceil(u/60),Math.ceil(e),Math.ceil(i),r,a,l,this.#de,d,this.#Ie,h];if(this.#ze<1){for(let e=0;e<p.length;e++)p[e].textContent=g[e];this.#Bt(p[4],o),this.#Mt()}}#bt(e){let t=this.#be.querySelector("tbody"),i=t.querySelectorAll("tr"),s=[e.positionInList+1,e.altitude,Math.ceil(e.length),Math.ceil(e.length/this.#G/60)],n=this.#_t(e),o=[Math.ceil(e.population),Math.ceil(e.groundArea),n.toExponential(2),(e.population/e.groundArea).toExponential(2),e.maxSquarePopulationDensity.toExponential(2)],r=[Math.ceil(e.NMAC_rate),e.expectedNMAC.toExponential(2)],a=[Math.ceil(e.firstPartyNMAC_rate||0),(e.expectedFirstPartyNMAC||0).toExponential(2)],l=s.concat(o,r,a);if(this.#l.length===i.length){let t=i[e.positionInList].querySelectorAll("td");for(let e=0;e<l.length;e++)t[e+1].textContent=l[e];t[0].style.background=e.polylineColor,this.#Bt(t[7],n)}else{let i=document.createElement("tr"),l=document.createElement("td");l.classList.add("color-column"),l.style.background=e.polylineColor,i.appendChild(l),this.#vt(i,s,"table-light"),this.#vt(i,o,"table-warning"),this.#vt(i,r,"table-primary"),this.#vt(i,a,"table-success");let d=i.querySelectorAll("td");this.#Bt(d[7],n),t.appendChild(i),this.#Ye||i.querySelectorAll(".table-success").forEach((e=>{e.style.opacity="0.5",e.style.cursor="not-allowed",e.title="1st-party risk data not available for this area"}))}}#vt(e,t,i){for(let s=0;s<t.length;s++){const n=document.createElement("td");n.classList.add(i),n.textContent=t[s],e.appendChild(n)}}#Bt(e,t){e&&(e.style.color=t<m.#K?"green":"red")}#Dt(){let e=this.#Fe/2;return Math.PI*e*e}#_t(e){return this.#Oe&&e.groundArea?this.#Je/this.#Oe*e.population*(this.#Dt()/e.groundArea):0}#Nt(){if(!this.#Oe)return 0;let e=this.#Dt(),t=this.#l.reduce(((t,i)=>t+(i.groundArea?i.population*e/i.groundArea:0)),0);return this.#Je/this.#Oe*t}#Ke(){this.#Ne=document.getElementById("nmac-slider"),this.#Ne.noUiSlider||noUiSlider.create(this.#Ne,{start:[this.#M],step:1,connect:"lower",tooltips:{to:e=>Math.round(e)},range:{min:[10],max:[1200]}}),this.#Ne.noUiSlider.on("change",this.#kt.bind(this))}#Qe(){this.#Be=document.getElementById("nmac-slider-fp"),this.#Be.noUiSlider||noUiSlider.create(this.#Be,{start:[this.#M],step:1,connect:"lower",tooltips:{to:e=>Math.round(e)},range:{min:[10],max:[1200]}}),this.#Be.noUiSlider.on("change",this.#kt.bind(this))}#kt(e,t){this.#M=Math.floor(e[t]),this.#Ne.noUiSlider.set(this.#M),this.#Be.noUiSlider.set(this.#M);for(let e of this.#l)e.NMAC_radius=this.#M,e.update();this.#yt("air"),this.#St(this.#l)}#et(){this.#ve=document.getElementById("extension-slider"),this.#ve.noUiSlider||noUiSlider.create(this.#ve,{start:[this.#pe],step:1,tooltips:{to:e=>Math.round(e)},connect:"lower",range:{min:[0],max:[1200]}}),this.#ve.noUiSlider.on("change",this.#Ut.bind(this)),this.#ve.noUiSlider.disable()}#Ut(e,t){this.#pe=Math.floor(e[t]),!this.#Me.checked||this.#Pt()}#tt(){this.#_e=document.getElementById("uav-speed-slider"),this.#_e.noUiSlider||noUiSlider.create(this.#_e,{start:[this.#G],step:.1,tooltips:{to:e=>Math.round(60*e*60/1e3)},connect:"lower",range:{min:[1],max:[50]}}),this.#_e.noUiSlider.on("change",this.#wt.bind(this))}#wt(e,t){this.#G=e[t],this.#l.map((e=>{e.v_UA=this.#G})),this.#St(this.#l)}#it(){this.#De=document.getElementById("global-altitude-slider"),this.#De.noUiSlider||noUiSlider.create(this.#De,{start:[this.#Q],step:1,tooltips:{to:e=>Math.round(e)},connect:"lower",range:{min:[10],max:[1200]}}),this.#De.noUiSlider.on("change",this.#Ft.bind(this))}#ot(){this.#ke=document.getElementById("drone-density-slider"),this.#ke.noUiSlider||noUiSlider.create(this.#ke,{start:[this.#Ue],step:1,tooltips:{to:e=>Math.round(e)},connect:"lower",range:{min:[1],max:[100]}}),this.#ke.noUiSlider.on("change",this.#Tt.bind(this))}#st(){this.#Pe=document.getElementById("fatality-probability-slider"),this.#Pe.noUiSlider||noUiSlider.create(this.#Pe,{start:[this.#Je],step:.01,tooltips:{to:e=>Number(e).toFixed(2)},connect:"lower",range:{min:[0],max:[1]}}),this.#Pe.noUiSlider.on("change",this.#It.bind(this))}#It(e,t){this.#Je=Number(e[t]),this.#dt(),this.#l.map((e=>{this.#bt(e)}))}#nt(){this.#Te=document.getElementById("mtbf-input"),this.#Te&&(this.#Te.value=this.#Oe,this.#Te.addEventListener("input",this.#Rt.bind(this)))}#Rt(e){let t=Number(e.target.value);this.#Oe=Number.isFinite(t)&&t>0?t:0,this.#dt(),this.#l.map((e=>{this.#bt(e)}))}#Tt(e,t){this.#Ue=Math.floor(e[t]),this.#St(this.#l)}#rt(){this.#we=document.getElementById("drone-dimension-slider"),this.#we.noUiSlider||noUiSlider.create(this.#we,{start:[this.#Fe],step:.01,tooltips:{to:e=>Number(e).toFixed(2)},connect:"lower",range:{min:[.1],max:[5]}}),this.#we.noUiSlider.on("change",this.#Gt.bind(this))}#Gt(e,t){this.#Fe=Number(e[t]),this.#dt(),this.#l.map((e=>{this.#bt(e)}))}#Ft(e,t){let i=e[t],s=[];for(let e of this.#l)e.altitudeManuallyChanged||(e.altitude=Math.floor(i),e.nodesList[0].altitudeUpdatedGlobally(i),s.push(e));s.map((e=>e.update()));let n=this.#l[this.#l.length-1];n.altitudeManuallyChanged||(n.nodesList[1].altitudeUpdatedGlobally(i),n.update()),this.#yt("ground"),this.#St(s)}#at(){this.#Me.addEventListener("change",this.#Pt.bind(this))}#lt(){this.#Ee.addEventListener("click",(()=>{this.#Ae=!this.#Ae,this.#Ae?(this.#Se.style.display="",this.#Ee.textContent="Hide",this.#Jt()):(this.#Se.style.display="none",this.#Ee.textContent="Show",this.#Ot())}))}#Jt(){for(let e=0;e<this.#l.length;e++)this.#l[e].polylineColor=colorNameList.pop().hex,this.#bt(this.#l[e])}#Ot(){for(let e of this.#l)e.polylineColor="#0d6efd",this.#bt(e)}#Pt(e){let t=0;this.#Me.checked?(t=this.#pe,this.#ve.noUiSlider.enable()):this.#ve.noUiSlider.disable(),this.#l.map((e=>{e.extraLength=t})),this.#l.map((e=>e.update())),this.#yt("ground"),this.#yt("air"),this.#St(this.#l)}}!function(){let e=new m("nk_area");$(document).ready((function(){$('input[name="area_switcher"]').on("change",(function(){e.deinitializeMap(),e=new m(this.id)}))}))}()})();