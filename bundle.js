(()=>{"use strict";class e{#e;#t;#i;#s;#n;#o;#r;#a;#l;#h;#d;#u;#p;#g;#c;#m;#f;#L;constructor(e,t,i){return this.#e=t,this.#t=!1,this.#i=null,this.#s=!1,this.#n=null,this.#o=!0,this.#r=L.marker(e,{draggable:!0,autoPan:!0}),this.#a=i,this.#l=[],this.#u=0,this.#r.on("moveend",this.#y.bind(this)),this.#g=this.#C(),this.#r.bindPopup(this.#g),this.#E(),this.#A(),this}#A(){this.#h=turf.circle(Object.values(this.#r.getLatLng()).toReversed(),this.#e/2,{units:"meters"}),this.#d=Math.PI*(this.#e/2)**2}#E(){this.#p=turf.point(Object.values(this.#r.getLatLng()).toReversed())}#C(){let e=document.createElement("popup-div"),t=document.createElement("p");t.innerHTML="Altitude",this.#m=document.createElement("slider-div"),this.#L=document.createElement("button"),this.#f=document.createElement("button"),this.#c=document.createElement("input");let i=document.createElement("label"),s=document.createElement("div");e.style.display="flex",e.style.flexDirection="column",this.#m.id="slider",this.#m.style.width="200px",noUiSlider.create(this.#m,{start:[this.#e],step:1,tooltips:{to:e=>Math.round(e)},connect:"lower",range:{min:10,max:1200}}),e.appendChild(this.#m),this.#m.noUiSlider.on("change",this.#x.bind(this)),e.appendChild(t),this.#f.innerHTML="Split segment",this.#f.style.color="BlueViolet",this.#f.style.background="white",this.#f.style.borderRadius="6px",e.appendChild(this.#f),e.appendChild(document.createElement("br")),this.#L.innerHTML="Remove waypoint",this.#L.style.color="Tomato",this.#L.style.background="white",this.#L.style.borderRadius="6px",e.appendChild(this.#L),e.appendChild(document.createElement("br")),this.#c.type="checkbox",this.#c.name="smooth",this.#c.checked=!0,i.innerHTML="Smooth altitude change";let n=document.createElement("i");n.className="fa-regular fa-circle-question",n.setAttribute("data-bs-toggle","tooltip"),n.setAttribute("title","Emulate how drone smoothly changes the altitude between two waypoints with the rate of 90 m altitude change per 1km of horizontal distance. When disabled, a sharp transition occurs."),new bootstrap.Tooltip(n);let o=document.createElement("sup");return o.appendChild(n),i.appendChild(o),i.for="smooth",i.style.paddingRight="10px",this.#c.addEventListener("change",this.#M.bind(this)),s.style.color="blue",i.style.color="black",s.appendChild(i),s.appendChild(this.#c),e.appendChild(s),e}#y(e){this.#r=e.target,this.#A(),this.#E();for(let e of this.#l)e.update()}#x(e,t){this.#e=Math.floor(e[t]),this.#A(),this.#t&&(this.#i.altitude=this.#e,this.#i.altitudeManuallyChanged=!0,this.#i.update()),this.#l.length>0&&this.#l[0].nodesList[0].isSmooth&&this.#l[0].update()}#M(e){this.#t&&(this.#o=0==this.#o,this.#i.update())}hasEdge(){return this.#t}hasNextCicle(){return this.#s}altitudeUpdatedGlobally(e){this.#e=e,this.#m.noUiSlider.set(e),this.#A()}get altitude(){return this.#e}get nextCicle(){return this.#n}get isSmooth(){return this.#o}get marker(){return this.#r}get splitButtonElement(){return this.#f}get removeButtonElement(){return this.#L}get smoothCheckboxElement(){return this.#c}get sliderElement(){return this.#m}get circle(){return this.#h}get circleArea(){return this.#d}get circleCoveredPopulation(){return this.#u}get point(){return this.#p}get edge(){return this.#i}get edgesList(){return this.#l}get positionInList(){return this.#a}set edge(e){this.#i=e,this.#t=!!e}set nextCicle(e){this.#n=e,this.#s=!!e}set positionInList(e){this.#a=e}set circleCoveredPopulation(e){this.#u=e}}class t{#e;#S;#b;#N;#B;#_;#v;#k;#U;#D;#a;#w;#P;#G;#T;#I;#J;#O;#R;#F;#q;#z;#j;#W;#Y;constructor(e,t,i,s,n){this.#e=i,this.#S=s,this.#B=0,this.#N=0,this.#_=[],this.#v=0,this.#k=0,this.#U=0,this.#D=0,this.#O=8.34,this.#a=n,this.#R=0,this.#F=0,this.#q=0,this.#j=[e,t],this.#W=0,this.#Y=!1,this.#H()}#H(){let[e,t]=this.#j,[i,s]=[Object.values(e.marker.getLatLng()),Object.values(t.marker.getLatLng())];this.#P=colorNameList.pop().hex,this.#w=new L.Polyline([i,s],{color:this.#P,weight:20,opacity:.9,smoothFactor:1}),e.edge=this,e.edgesList.push(this),t.edgesList.push(this),this.#X()}#Z(t,i){let s=turf.bearing(t.point,i.point),n=turf.destination(i.point,this.#W,s,{units:"meters"});return new e(n.geometry.coordinates.toReversed(),i.altitude,-1)}#X(){let[e,t]=this.#j;this.#q=turf.distance(e.point,t.point,{units:"meters"});let i=null;this.#W>0&&(i=this.#Z(e,t));let s=[Object.values(e.marker.getLatLng()),Object.values(t.marker.getLatLng())];!(this.#W>0)||(s[1]=Object.values(i.marker.getLatLng())),this.#w.setLatLngs(s),this.#I=turf.buffer(this.#w.toGeoJSON(),this.#S,{units:"meters"}),this.#J=turf.area(this.#I,{units:"meters"});let n=Math.abs(t.altitude-e.altitude)/90*1e3,o=this.#q>=n&&t.altitude!=e.altitude;if(e.isSmooth&&o){let s=(this.#q-n)/this.#q,o=this.#$(s),r=L.polygon(o.map((function(e){return e.geometry.coordinates.toReversed()})),{color:"purple",weight:6,opacity:.5,smoothFactor:1}),a=turf.union(e.circle,r.toGeoJSON()),l=this.#W>0?i:t,h=turf.union(a,l.circle),d=.001;this.#T=turf.buffer(h,d,{units:"meters"})}else this.#T=turf.buffer(this.#w.toGeoJSON(),this.#e/2,{units:"meters"});this.#F=turf.area(this.#T,{units:"meters"}),this.#q+=this.#W}#$(e){let[t,i]=this.#j,s=null,[n,o]=[t.point,i.point],r=turf.bearing(n,o),a=turf.destination(n,t.altitude/2,(r+90)%180,{units:"meters"}),l=turf.destination(n,-t.altitude/2,(r+90)%180,{units:"meters"}),h=turf.destination(o,i.altitude/2,(r+90)%180,{units:"meters"}),d=turf.destination(o,-i.altitude/2,(r+90)%180,{units:"meters"}),u=turf.destination(a,this.#q*e,r,{units:"meters"}),p=turf.destination(l,this.#q*e,r,{units:"meters"});return this.#W>0?(s=this.#Z(t,i),[a,u,h,turf.destination(h,this.#W,r,{units:"meters"}),turf.destination(d,this.#W,r,{units:"meters"}),d,p,l]):[a,u,h,d,p,l]}#V(e,t,i){let s=2*this.#S**2*e*Math.sqrt(this.#O**2+t**2)/(this.#S*this.#J)*i;this.#N=this.#q/this.#O*s,this.#b=60*s*60*1e6}update(){this.#X()}computeNMAC_rate(e,t,i){this.#V(e,t,i)}computeFirstPartyNMAC_rate(e,t,i){let s=Math.sqrt(2*t**2),n=2*this.#S**2*e*s/(this.#S*this.#J)*i;this.#D=this.#q/t*n,this.#U=60*n*60*1e6}get population(){return this.#R}get length(){return this.#q}get groundArea(){return this.#F}get airBufferArea(){return this.#J}get polyline(){return this.#w}get polylineColor(){return this.#P}get groundBuffer(){return this.#T}get airBuffer(){return this.#I}get nodesList(){return this.#j}get altitude(){return this.#e}get NMAC_radius(){return this.#S}get NMAC_rate(){return this.#b}get expectedNMAC(){return this.#N}get NMAC_time(){return this.#B}get NMAC_avg_speeds(){return this.#_}get maxSquarePopulationDensity(){return this.#v}get firstPartyDn(){return this.#k}get firstPartyNMAC_rate(){return this.#U}get expectedFirstPartyNMAC(){return this.#D}get positionInList(){return this.#a}get extraLength(){return this.#W}get altitudeManuallyChanged(){return this.#Y}set population(e){this.#R=e}set altitude(e){this.#e=e}set positionInList(e){this.#a=e}set NMAC_radius(e){this.#S=e}set NMAC_time(e){this.#B=e}set NMAC_avg_speeds(e){this.#_=e}set maxSquarePopulationDensity(e){this.#v=e}set extraLength(e){this.#W=e}set v_UA(e){this.#O=e}set altitudeManuallyChanged(e){this.#Y=e}set firstPartyDn(e){this.#k=e}}function i(e){let t=e.properties.B;return 0===t||null==t?{fillOpacity:0,weight:0,opacity:0}:{fillColor:(i=t,i>500?"#800026":i>300?"#BD0026":i>200?"#E31A1C":i>100?"#FC4E2A":i>50?"#FD8D3C":i>20?"#FEB24C":i>10||i>-10?"#FED976":"#FFEDA0"),weight:0,opacity:1,color:"CadetBlue",dashArray:"10",fillOpacity:.5};var i}function s(e){let t=e.properties.T;return 0===t||null==t?{fillOpacity:0,weight:0,opacity:0}:{fillColor:(i=t,i>.01?"#000033":i>.005?"#000066":i>.001?"#000099":i>5e-4?"#0000CC":i>1e-4?"#0033FF":i>5e-5?"#0099FF":i>1e-5?"#00CCFF":i>-10?"#00FFCC":"#FFEDA0"),weight:0,opacity:1,color:"CadetBlue",dashArray:"10",fillOpacity:.5};var i}function n(e){let t=e.properties.Dn;return 0===t||null==t?{fillOpacity:0,weight:0,opacity:0}:{fillColor:(i=t,i>.05?"#004d00":i>.01?"#006600":i>.005?"#008000":i>.001?"#00b300":i>5e-4?"#00cc00":i>1e-4?"#00e600":i>1e-5?"#33ff33":i>0?"#99ff99":"#FFEDA0"),weight:0,opacity:1,color:"CadetBlue",dashArray:"10",fillOpacity:.5};var i}function o(){return{color:"black",weight:1,opacity:.95}}function r(){return{color:"black",weight:1,opacity:.95}}function a(e,t){let i=[];for(let s of e){let e=turf.bbox(s),n={minX:e[0],minY:e[1],maxX:e[2],maxY:e[3]},o=t.search(n).map((e=>e.id));i=i.concat(o)}return i}let l=window["polyclip-ts"],h={nk_area:"./data/population_nk_processed_06w2_with_D.geojson",stockholm_area:"./data/population_stockholm.geojson",ockero_area:"./data/population_ockero.geojson",vastervik_area:"./data/population_vastervik.geojson"},d={nk_area:[58.5877,16.1924],stockholm_area:[59.3118,18.0663],ockero_area:[57.71,11.65],vastervik_area:[57.75,16.63]},u={nk_area:12,stockholm_area:11,ockero_area:12,vastervik_area:12};const p="Ground risk",g="Air risk",c='1st-party risk <span style="color: red; font-weight: bold;">(experimental)</span>';class m{#K;#j;#l;#Q;#ee;#te;#ie;#se;#ne;#oe;#re;#ae;#le;#he;#de;#S;#ue;#O;#pe;#ge;#ce;#me;#fe;#Le;#ye;#Ce;#Ee;#Ae;#xe;#Me;#Se;#be;#Ne;#Be;#_e;#ve;#ke;#R;#Ue;#De;#we;#Pe;#Ge;#Te;constructor(e){this.#Ge=e,this.#Te=h[e]??h.nk_area,console.log(this.#Te),this.#K=200,this.#j=[],this.#l=[],this.#Q=L.layerGroup([]),this.#ee=L.layerGroup([]),this.#ie=null,this.#se=null,this.#ne=L.layerGroup([]),this.#oe=null,this.#re=null,this.#ae=L.layerGroup([]),this.#le=0,this.#he=0,this.#de=0,this.#S=50,this.#ue=100,this.#O=8.34,this.#Be=1,this.#_e=0,this.#ve=0,this.#ke=0,this.#pe=document.getElementById("population"),this.#ge=document.getElementById("length"),this.#ce=document.getElementById("area"),this.#me=document.getElementById("exposed-density"),this.#fe=document.getElementById("exposed-length-weight"),this.#Le=document.getElementById("nmac-rate"),this.#ye=document.getElementById("totals-table"),this.#Ce=document.getElementById("segments-table"),this.#Ee=document.getElementById("segment-extension"),this.#Ae=document.getElementById("spinner-container"),this.#R=null,this.#Ue=null,this.#De=0,this.#we=!0,this.#Pe=null,document.getElementById("currentYear").textContent=(new Date).getFullYear(),this.#Ie(),this.#Je(),this.#Oe(),this.#Re(),this.#Fe(),this.#qe(),this.#ze(),this.#je(),this.#We(),this.#Ye()}#He(e){}async#Ie(){let e=new Promise(((e,t)=>{$.getJSON(this.#Te,(function(i,s,n){"success"===s?e(i):t(error)}))}));try{this.#R=await e}catch(e){console.error("Error fetching data:",e)}if(this.#we)try{this.#Pe=function(e){let t=new RBush,i=e.map(((e,t)=>{let i=e.geometry.coordinates[0][0];return{minX:i[0][0],minY:i[3][1],maxX:i[2][0],maxY:i[1][1],id:t}}));return t.load(i),t}(this.#R.features)}catch(e){console.error("Error creating R-Tree of the data:",e)}this.#ke=this.#R.features.reduce(((e,t)=>e+(t.properties.Dn||0)),0),console.log("Total Dn sum:",this.#ke)}async#Je(){await this.#Ie();let e=L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:20,attribution:'&copy <a href="http://openstreetmap.org">OpenStreetMap</a> &copy; <a href="https://www.lantmateriet.se/en/">Lantmäteriet</a>'}),t=L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:20,attribution:'&copy <a href="http://openstreetmap.org">OpenStreetMap</a> &copy; <a href="https://www.lantmateriet.se/en/">Lantmäteriet</a>'}),o=L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:20,attribution:'&copy <a href="http://openstreetmap.org">OpenStreetMap</a> &copy; <a href="https://www.lantmateriet.se/en/">Lantmäteriet</a>'});this.#te=L.map("map",{doubleClickZoom:!1,preferCanvas:!0,layers:[e]}).setView(d[this.#Ge],u[this.#Ge]),L.control.layers({[p]:e,[g]:t,[c]:o},null,{collapsed:!1}).addTo(this.#te);let r=L.geoJSON(this.#R,{style:i}).addTo(this.#te),a=L.geoJSON(this.#R,{style:s}),l=L.geoJSON(this.#R,{style:n});this.#ne.addTo(this.#te),this.#Q.addTo(this.#te),this.#ee.addTo(this.#te),this.#te.on("baselayerchange",function(e){r.remove(),a.remove(),l.remove(),this.#ne.remove(),this.#ae.remove(),this.#ee.remove(),e.name===p?(r.addTo(this.#te),this.#ne.addTo(this.#te)):e.name===g?(a.addTo(this.#te),this.#ae.addTo(this.#te)):e.name===c&&(l.addTo(this.#te),this.#ne.addTo(this.#te)),this.#ee.addTo(this.#te)}.bind(this)),this.#te.on("dblclick",this.#Xe.bind(this))}deinitializeMap(){null!=this.#te&&this.#te.remove()}#Oe(){[].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]')).map((function(e){return new bootstrap.Tooltip(e)}))}#Xe(i){let s=this.#j.length>0?this.#j[this.#j.length-1].altitude:this.#K,n=Object.values(i.latlng);const o=new e(n,s,this.#j.length);if(this.#Q.addLayer(o.marker),this.#Ze(o),this.#j.length>0&&(this.#j[this.#j.length-1].nextCicle=o),this.#j.push(o),this.#j.length>1){let[e,i]=this.#j.slice(this.#j.length-2,this.#j.length),s=new t(e,i,e.altitude,this.#S,this.#l.length);this.#Ee.checked&&(s.extraLength=this.#ue,s.update()),this.#ee.addLayer(s.polyline),this.#l.push(s),this.#$e("ground"),this.#$e("air"),this.#Ve([s])}}#Ze(e){e.smoothCheckboxElement.addEventListener("change",(t=>{e.hasEdge()&&(this.#$e("ground"),this.#Ve([e.edge]))})),e.sliderElement.noUiSlider.on("change",((t,i)=>{this.#$e("ground"),e.hasEdge()&&2===e.edgesList.length&&e.edgesList[0].nodesList[0].isSmooth||!e.hasEdge()&&1===e.edgesList.length&&e.edgesList[0].nodesList[0].isSmooth?this.#Ve(e.edgesList):e.hasEdge()&&this.#Ve([e.edge])})),e.splitButtonElement.addEventListener("click",(()=>{this.#Ke(e)})),e.removeButtonElement.addEventListener("click",(()=>{this.#Qe(e)})),e.marker.on("moveend",(t=>{this.#$e("ground"),this.#$e("air"),this.#Ve(e.edgesList)}))}#Ke(i){if(i.hasEdge()){let s=Object.values(i.edge.polyline.getCenter()),n=new e(s,i.altitude,i.positionInList+1),o=null,r=i.edge.nodesList[1];this.#Q.addLayer(n.marker),this.#Ze(n),i.nextCicle=n,n.nextCicle=r,this.#j.splice(i.positionInList+1,0,n),i.edge.nodesList[1]=n,n.edgesList[0]=i.edge,i.edge.update(),1===r.edgesList.length?(r.edgesList.pop(),o=new t(n,r,n.altitude,this.#S,i.edge.positionInList+1)):2===r.edgesList.length&&(o=new t(n,r,n.altitude,this.#S,i.edge.positionInList+1),r.edgesList.reverse(),r.edgesList.pop()),this.#ee.addLayer(o.polyline),this.#l.splice(i.edge.positionInList+1,0,o),this.#$e("ground"),this.#$e("air"),this.#Ve([i.edge,o]),this.#j.slice(i.positionInList+2,this.#j.length).map((e=>{e.positionInList+=1})),this.#l.slice(i.edge.positionInList+2,this.#l.length).map((e=>{e.positionInList+=1})),this.#l.slice(i.edge.positionInList,this.#l.length).map((e=>{this.#et(e)}))}}#Qe(e){if(e.hasEdge()&&1===e.edgesList.length)this.#j.splice(0,1),this.#Q.removeLayer(e.marker),this.#l.splice(0,1),this.#ee.removeLayer(e.edge.polyline),this.#j[0].edgesList.splice(0,1),this.#j.map((e=>{e.positionInList-=1})),this.#l.map((e=>{e.positionInList-=1})),this.#Ce.querySelector("tbody").deleteRow(0),this.#$e("ground"),this.#$e("air"),this.#tt([]),this.#l.map((e=>{this.#et(e)}));else if(e.hasEdge()||1!==e.edgesList.length){if(2===e.edgesList.length){this.#j.splice(e.positionInList,1),this.#Q.removeLayer(e.marker),this.#l.splice(e.edge.positionInList,1),this.#ee.removeLayer(e.edge.polyline),this.#Ce.querySelector("tbody").deleteRow(e.edge.positionInList);let t=e.edgesList[0].nodesList[0],i=e.edge.nodesList[1];t.nextCycle=i,t.edge.nodesList[1]=i,i.edgesList[0]=t.edge,t.edge.update(),this.#j.slice(e.positionInList,this.#j.length).map((e=>{e.positionInList-=1})),this.#l.slice(e.edge.positionInList,this.#l.length).map((e=>{e.positionInList-=1})),this.#$e("ground"),this.#$e("air"),this.#Ve([t.edge]),this.#l.slice(e.edge.positionInList,this.#l.length).map((e=>{this.#et(e)}))}}else{this.#j.splice(this.#j.length-1,1),this.#Q.removeLayer(e.marker),this.#l.splice(this.#l.length-1,1);let t=e.edgesList[0].nodesList[0];t.edge.polyline.remove(),t.edgesList.pop(),t.edge=null,t.nextCycle=null,this.#Ce.querySelector("tbody").deleteRow(this.#l.length),this.#$e("ground"),this.#$e("air"),this.#tt([])}}#$e(e){"ground"===e&&null!=this.#se?this.#ne.removeLayer(this.#se):"air"===e&&null!=this.#re&&this.#ae.removeLayer(this.#re);let t=this.#l.map((t=>"ground"===e?t.groundBuffer:t.airBuffer)),i=this.#it(t);"ground"===e?(this.#ie=i,this.#se=L.geoJSON(i,{style:o}),this.#ne.addLayer(this.#se)):"air"===e&&(this.#oe=i,this.#re=L.geoJSON(i,{style:r}),this.#ae.addLayer(this.#re))}#it(e){let t=this.#j.map((e=>Object.values(e.point.geometry.coordinates.toReversed())));if(console.log("nodesCoordinates: ",JSON.stringify(t,null,2)),this.#l.length>0){let t=l.union(...e.map((e=>e.geometry.coordinates)));return turf.buffer(turf.multiPolygon(t),1e-4,{units:"meters"})}return null}#tt(e){clearTimeout(this.#Ue),this.#Ue=setTimeout((()=>{this.#Ve(e)}),1e3)}async#Ve(e){if(await this.#Ie(),this.#ie){this.#De<1&&this.#st(),this.#De++,this.#le=0,e.map((e=>{e.population=0}));let t=null;if(this.#we){let i=a(e.map((e=>e.groundBuffer)),this.#Pe),s=a(e.map((e=>e.airBuffer)),this.#Pe);t=Array.from(new Set(i.concat(s))).map((e=>this.#R.features[e]))}else t=this.#R.features;let i=t.length>1e3?4:1,s=Math.ceil(t.length/i),n=[],o=[],r=[],l=[],h=[],d=[],u=[],p=1e4;for(let a=0;a<i;a++){let g=a*s,c=g+s,m=t.slice(g,c),f=new Worker("./src/workers.js"),L=e.map((e=>e.groundBuffer)),y=e.map((e=>e.airBuffer)),C=e.map((e=>{let[t,i]=e.nodesList;return[t.circleCoveredPopulation,i.circleCoveredPopulation]=[0,0],[t.circle,i.circle]}));f.postMessage([m,L,y,C,p]),f.onmessage=function(t){let[s,a,g,c,m,f]=t.data;if(o.push(s),r.push(a),l.push(g),h.push(c),d.push(m),u.push(f),o.length===i){for(let t=0;t<e.length;t++){let i=e[t];i.population=o.map((e=>e[t])).reduce(((e,t)=>e+t),0),i.maxSquarePopulationDensity=Math.max(...d.map((e=>e[t])))/p;let s=r.map((e=>e[t])),n=s.reduce(((e,t)=>e.map(((e,i)=>e+t[i])))),[a,g]=i.nodesList;a.circleCoveredPopulation=n[0],g.circleCoveredPopulation=n[1];let c=l.map((e=>e[t])).reduce(((e,t)=>e+t),0);i.NMAC_time=c;let m=h.map((e=>e[t]));m=m.flat().filter((e=>e>0)),i.NMAC_avg_speeds=m;let f=m.reduce(((e,t)=>e+t),0)/m.length||0,L=this.#R.features[0].properties.p;i.computeNMAC_rate(c,f,L);let y=u.map((e=>e[t])).reduce(((e,t)=>e+t),0),C=this.#ke>0?y/this.#ke:0;i.firstPartyDn=C,i.computeFirstPartyNMAC_rate(C*this.#Be,this.#O,L)}let t=this.#l.reduce((function(e,t){return e.concat(t.NMAC_avg_speeds)}),[]).flat(),i=t.length>0?t.reduce(((e,t)=>e+t),0)/t.length:0,s=this.#l.reduce(((e,t)=>e+t.airBufferArea),0),a=this.#l.reduce(((e,t)=>e+t.NMAC_time),0),g=2*this.#S**2*a*Math.sqrt(this.#O**2+i**2)/(this.#S*s)*this.#R.features[0].properties.p,c=this.#l.reduce(((e,t)=>e+t.length),0);this.#he=c/this.#O*g,this.#de=c/this.#O,this.#le=Math.ceil(3600*g*1e6);let m=this.#l.reduce(((e,t)=>e+(t.firstPartyDn||0)),0),f=2*this.#S**2*m*this.#Be*Math.sqrt(2*this.#O**2)/(this.#S*s)*this.#R.features[0].properties.p;this.#ve=c/this.#O*f,this.#_e=Math.ceil(3600*f*1e6),this.#De--,this.#Ye(),e.map((e=>{this.#et(e)})),n.forEach((function(e){e.terminate()}))}}.bind(this),n.push(f)}}}#st(){this.#Ae.style.display="block";let e=this.#ye.querySelector("tbody").querySelector("tr").querySelectorAll("td");for(let t of e)t.innerHTML='<div class="spinner-grow spinner-grow-sm text-primary" role="status"></div>'}#nt(){this.#Ae.style.display="none"}#ot(){let e=0,t=0;for(let i=0;i<this.#l.length-1;i++){let s=this.#l[i],n=this.#l[i+1];e+=Math.min(s.nodesList[1].circleCoveredPopulation,n.nodesList[0].circleCoveredPopulation),t+=Math.min(s.nodesList[1].circleArea,n.nodesList[0].circleArea)}return[e,t]}#Ye(){let e=this.#l.reduce(((e,t)=>e+t.population),0),t=this.#l.reduce(((e,t)=>e+t.length),0),i=this.#l.reduce(((e,t)=>e+t.groundArea),0),[s,n]=this.#ot();e-=s,i-=n;let o=t?(e/t).toExponential(2):0,r=i?(e/i).toExponential(2):0,a=this.#l.reduce(((e,t)=>Math.max(e,t.maxSquarePopulationDensity)),0),l=i?this.#he.toExponential(2):0,h=i?this.#ve.toExponential(2):0,d=this.#de,u=this.#ye.querySelector("tbody").querySelector("tr").querySelectorAll("td"),p=[Math.ceil(t),Math.ceil(d/60),Math.ceil(e),Math.ceil(i),o,r,a,this.#le,l,this.#_e,h];if(this.#De<1){for(let e=0;e<u.length;e++)u[e].textContent=p[e];this.#nt()}}#et(e){let t=this.#Ce.querySelector("tbody"),i=t.querySelectorAll("tr"),s=[e.positionInList+1,e.altitude,Math.ceil(e.length),Math.ceil(e.length/this.#O/60)],n=[Math.ceil(e.population),Math.ceil(e.groundArea),(e.population/e.length).toExponential(2),(e.population/e.groundArea).toExponential(2),e.maxSquarePopulationDensity.toExponential(2)],o=[Math.ceil(e.NMAC_rate),e.expectedNMAC.toExponential(2)],r=[Math.ceil(e.firstPartyNMAC_rate||0),(e.expectedFirstPartyNMAC||0).toExponential(2)],a=s.concat(n,o,r);if(this.#l.length===i.length){let t=i[e.positionInList].querySelectorAll("td");for(let e=0;e<a.length;e++)t[e+1].textContent=a[e];t[0].style.background=e.polylineColor}else{let i=document.createElement("tr"),a=document.createElement("td");a.classList.add("color-column"),a.style.background=e.polylineColor,i.appendChild(a),this.#rt(i,s,"table-light"),this.#rt(i,n,"table-warning"),this.#rt(i,o,"table-primary"),this.#rt(i,r,"table-success"),t.appendChild(i)}}#rt(e,t,i){for(let s=0;s<t.length;s++){const n=document.createElement("td");n.classList.add(i),n.textContent=t[s],e.appendChild(n)}}#Re(){this.#xe=document.getElementById("nmac-slider"),this.#xe.noUiSlider||noUiSlider.create(this.#xe,{start:[this.#S],step:1,connect:"lower",tooltips:{to:e=>Math.round(e)},range:{min:[10],max:[1200]}}),this.#xe.noUiSlider.on("change",this.#at.bind(this))}#at(e,t){this.#S=Math.floor(e[t]);for(let e of this.#l)e.NMAC_radius=this.#S,e.update();this.#$e("air"),this.#tt(this.#l)}#Fe(){this.#Se=document.getElementById("extension-slider"),this.#Se.noUiSlider||noUiSlider.create(this.#Se,{start:[this.#ue],step:1,tooltips:{to:e=>Math.round(e)},connect:"lower",range:{min:[0],max:[1200]}}),this.#Se.noUiSlider.on("change",this.#lt.bind(this)),this.#Se.noUiSlider.disable()}#lt(e,t){this.#ue=Math.floor(e[t]),!this.#Ee.checked||this.#ht()}#qe(){this.#Me=document.getElementById("uav-speed-slider"),this.#Me.noUiSlider||noUiSlider.create(this.#Me,{start:[this.#O],step:.1,tooltips:{to:e=>Math.round(60*e*60/1e3)},connect:"lower",range:{min:[1],max:[50]}}),this.#Me.noUiSlider.on("change",this.#dt.bind(this))}#dt(e,t){this.#O=e[t],this.#l.map((e=>{e.v_UA=this.#O})),this.#tt(this.#l)}#ze(){this.#be=document.getElementById("global-altitude-slider"),this.#be.noUiSlider||noUiSlider.create(this.#be,{start:[this.#K],step:1,tooltips:{to:e=>Math.round(e)},connect:"lower",range:{min:[10],max:[1200]}}),this.#be.noUiSlider.on("change",this.#ut.bind(this))}#je(){this.#Ne=document.getElementById("drone-density-slider"),this.#Ne.noUiSlider||noUiSlider.create(this.#Ne,{start:[this.#Be],step:1,tooltips:{to:e=>Math.round(e)},connect:"lower",range:{min:[1],max:[100]}}),this.#Ne.noUiSlider.on("change",this.#pt.bind(this))}#pt(e,t){this.#Be=Math.floor(e[t]),this.#tt(this.#l)}#ut(e,t){let i=e[t],s=[];for(let e of this.#l)e.altitudeManuallyChanged||(e.altitude=Math.floor(i),e.nodesList[0].altitudeUpdatedGlobally(i),s.push(e));s.map((e=>e.update()));let n=this.#l[this.#l.length-1];n.altitudeManuallyChanged||(n.nodesList[1].altitudeUpdatedGlobally(i),n.update()),this.#$e("ground"),this.#tt(s)}#We(){this.#Ee.addEventListener("change",this.#ht.bind(this))}#ht(e){let t=0;this.#Ee.checked?(t=this.#ue,this.#Se.noUiSlider.enable()):this.#Se.noUiSlider.disable(),this.#l.map((e=>{e.extraLength=t})),this.#l.map((e=>e.update())),this.#$e("ground"),this.#$e("air"),this.#tt(this.#l)}}!function(){let e=new m("nk_area");$(document).ready((function(){$('input[name="area_switcher"]').on("change",(function(){e.deinitializeMap(),e=new m(this.id)}))}))}()})();