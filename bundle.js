(()=>{"use strict";class e{#e;#t;#i;#s;#n;#o;#r;#a;#l;#h;#d;#u;#p;#g;#c;#m;#f;#y;constructor(e,t,i){return this.#e=t,this.#t=!1,this.#i=null,this.#s=!1,this.#n=null,this.#o=!0,this.#r=L.marker(e,{draggable:!0,autoPan:!0}),this.#a=i,this.#l=[],this.#u=0,this.#r.on("moveend",this.#L.bind(this)),this.#g=this.#C(),this.#r.bindPopup(this.#g),this.#S(),this.#b(),this}#b(){this.#h=turf.circle(Object.values(this.#r.getLatLng()).toReversed(),this.#e/2,{units:"meters"}),this.#d=Math.PI*(this.#e/2)**2}#S(){this.#p=turf.point(Object.values(this.#r.getLatLng()).toReversed())}#C(){let e=document.createElement("popup-div"),t=document.createElement("p");t.innerHTML="Altitude",this.#m=document.createElement("slider-div"),this.#y=document.createElement("button"),this.#f=document.createElement("button"),this.#c=document.createElement("input");let i=document.createElement("label"),s=document.createElement("div");e.style.display="flex",e.style.flexDirection="column",this.#m.id="slider",this.#m.style.width="200px",noUiSlider.create(this.#m,{start:[this.#e],step:1,tooltips:{to:e=>Math.round(e)},connect:"lower",range:{min:10,max:1200}}),e.appendChild(this.#m),this.#m.noUiSlider.on("change",this.#E.bind(this)),e.appendChild(t),this.#f.innerHTML="Split segment",this.#f.style.color="BlueViolet",this.#f.style.background="white",this.#f.style.borderRadius="6px",e.appendChild(this.#f),e.appendChild(document.createElement("br")),this.#y.innerHTML="Remove waypoint",this.#y.style.color="Tomato",this.#y.style.background="white",this.#y.style.borderRadius="6px",e.appendChild(this.#y),e.appendChild(document.createElement("br")),this.#c.type="checkbox",this.#c.name="smooth",this.#c.checked=!0,i.innerHTML="Smooth altitude change";let n=document.createElement("i");n.className="fa-regular fa-circle-question",n.setAttribute("data-bs-toggle","tooltip"),n.setAttribute("title","Emulate how drone smoothly changes the altitude between two waypoints with the rate of 90 m altitude change per 1km of horizontal distance. When disabled, a sharp transition occurs."),new bootstrap.Tooltip(n);let o=document.createElement("sup");return o.appendChild(n),i.appendChild(o),i.for="smooth",i.style.paddingRight="10px",this.#c.addEventListener("change",this.#A.bind(this)),s.style.color="blue",i.style.color="black",s.appendChild(i),s.appendChild(this.#c),e.appendChild(s),e}#L(e){this.#r=e.target,this.#b(),this.#S();for(let e of this.#l)e.update()}#E(e,t){this.#e=Math.floor(e[t]),this.#b(),this.#t&&(this.#i.altitude=this.#e,this.#i.altitudeManuallyChanged=!0,this.#i.update()),this.#l.length>0&&this.#l[0].nodesList[0].isSmooth&&this.#l[0].update()}#A(e){this.#t&&(this.#o=0==this.#o,this.#i.update())}hasEdge(){return this.#t}hasNextCicle(){return this.#s}altitudeUpdatedGlobally(e){this.#e=e,this.#m.noUiSlider.set(e),this.#b()}get altitude(){return this.#e}get nextCicle(){return this.#n}get isSmooth(){return this.#o}get marker(){return this.#r}get splitButtonElement(){return this.#f}get removeButtonElement(){return this.#y}get smoothCheckboxElement(){return this.#c}get sliderElement(){return this.#m}get circle(){return this.#h}get circleArea(){return this.#d}get circleCoveredPopulation(){return this.#u}get point(){return this.#p}get edge(){return this.#i}get edgesList(){return this.#l}get positionInList(){return this.#a}set edge(e){this.#i=e,this.#t=!!e}set nextCicle(e){this.#n=e,this.#s=!!e}set positionInList(e){this.#a=e}set circleCoveredPopulation(e){this.#u=e}}class t{#e;#x;#M;#B;#N;#_;#v;#D;#k;#U;#a;#w;#P;#I;#T;#F;#R;#G;#J;#O;#z;#q;#H;#j;#W;constructor(e,t,i,s,n){this.#e=i,this.#x=s,this.#N=0,this.#B=0,this.#_=[],this.#v=0,this.#D=0,this.#k=0,this.#U=0,this.#G=8.34,this.#a=n,this.#J=0,this.#O=0,this.#z=0,this.#H=[e,t],this.#j=0,this.#W=!1,this.#Y()}#Y(){let[e,t]=this.#H,[i,s]=[Object.values(e.marker.getLatLng()),Object.values(t.marker.getLatLng())];this.#P="#0d6efd",this.#w=new L.Polyline([i,s],{color:this.#P,weight:20,opacity:.9,smoothFactor:1}),e.edge=this,e.edgesList.push(this),t.edgesList.push(this),this.#X()}#Z(t,i){let s=turf.bearing(t.point,i.point),n=turf.destination(i.point,this.#j,s,{units:"meters"});return new e(n.geometry.coordinates.toReversed(),i.altitude,-1)}#X(){let[e,t]=this.#H;this.#z=turf.distance(e.point,t.point,{units:"meters"});let i=null;this.#j>0&&(i=this.#Z(e,t));let s=[Object.values(e.marker.getLatLng()),Object.values(t.marker.getLatLng())];!(this.#j>0)||(s[1]=Object.values(i.marker.getLatLng())),this.#w.setLatLngs(s),this.#F=turf.buffer(this.#w.toGeoJSON(),this.#x,{units:"meters"}),this.#R=turf.area(this.#F,{units:"meters"});let n=Math.abs(t.altitude-e.altitude)/90*1e3,o=this.#z>=n&&t.altitude!=e.altitude;if(e.isSmooth&&o){let s=(this.#z-n)/this.#z,o=this.#$(s),r=L.polygon(o.map((function(e){return e.geometry.coordinates.toReversed()})),{color:"purple",weight:6,opacity:.5,smoothFactor:1}),a=turf.union(e.circle,r.toGeoJSON()),l=this.#j>0?i:t,h=turf.union(a,l.circle),d=.001;this.#T=turf.buffer(h,d,{units:"meters"})}else this.#T=turf.buffer(this.#w.toGeoJSON(),this.#e/2,{units:"meters"});this.#O=turf.area(this.#T,{units:"meters"}),this.#z+=this.#j}#$(e){let[t,i]=this.#H,s=null,[n,o]=[t.point,i.point],r=turf.bearing(n,o),a=turf.destination(n,t.altitude/2,(r+90)%180,{units:"meters"}),l=turf.destination(n,-t.altitude/2,(r+90)%180,{units:"meters"}),h=turf.destination(o,i.altitude/2,(r+90)%180,{units:"meters"}),d=turf.destination(o,-i.altitude/2,(r+90)%180,{units:"meters"}),u=turf.destination(a,this.#z*e,r,{units:"meters"}),p=turf.destination(l,this.#z*e,r,{units:"meters"});return this.#j>0?(s=this.#Z(t,i),[a,u,h,turf.destination(h,this.#j,r,{units:"meters"}),turf.destination(d,this.#j,r,{units:"meters"}),d,p,l]):[a,u,h,d,p,l]}#V(e,t,i){let s=2*this.#x**2*e*Math.sqrt(this.#G**2+t**2)/(this.#x*this.#R)*i;this.#B=this.#z/this.#G*s,this.#M=60*s*60*1e6}update(){this.#X()}computeNMAC_rate(e,t,i){this.#V(e,t,i)}computeFirstPartyNMAC_rate(e,t,i){let s=Math.sqrt(2*t**2),n=2*this.#x**2*e*s/(this.#x*this.#R)*i;this.#U=this.#z/t*n,this.#k=60*n*60*1e6}get population(){return this.#J}get length(){return this.#z}get groundArea(){return this.#O}get airBufferArea(){return this.#R}get polyline(){return this.#w}get polylineColor(){return this.#P}get groundBuffer(){return this.#T}get airBuffer(){return this.#F}get nodesList(){return this.#H}get altitude(){return this.#e}get NMAC_radius(){return this.#x}get NMAC_rate(){return this.#M}get expectedNMAC(){return this.#B}get NMAC_time(){return this.#N}get NMAC_avg_speeds(){return this.#_}get maxSquarePopulationDensity(){return this.#v}get firstPartyDn(){return this.#D}get firstPartyNMAC_rate(){return this.#k}get expectedFirstPartyNMAC(){return this.#U}get positionInList(){return this.#a}get extraLength(){return this.#j}get altitudeManuallyChanged(){return this.#W}set population(e){this.#J=e}set altitude(e){this.#e=e}set positionInList(e){this.#a=e}set NMAC_radius(e){this.#x=e}set NMAC_time(e){this.#N=e}set NMAC_avg_speeds(e){this.#_=e}set maxSquarePopulationDensity(e){this.#v=e}set extraLength(e){this.#j=e}set v_UA(e){this.#G=e}set altitudeManuallyChanged(e){this.#W=e}set firstPartyDn(e){this.#D=e}}function i(e){let t=e.properties.B;return 0===t||null==t?{fillOpacity:0,weight:0,opacity:0}:{fillColor:(i=t,i>500?"#800026":i>300?"#BD0026":i>200?"#E31A1C":i>100?"#FC4E2A":i>50?"#FD8D3C":i>20?"#FEB24C":i>10||i>-10?"#FED976":"#FFEDA0"),weight:0,opacity:1,color:"CadetBlue",dashArray:"10",fillOpacity:.5};var i}function s(e){let t=e.properties.T;return 0===t||null==t?{fillOpacity:0,weight:0,opacity:0}:{fillColor:(i=t,i>.01?"#000033":i>.005?"#000066":i>.001?"#000099":i>5e-4?"#0000CC":i>1e-4?"#0033FF":i>5e-5?"#0099FF":i>1e-5?"#00CCFF":i>-10?"#00FFCC":"#FFEDA0"),weight:0,opacity:1,color:"CadetBlue",dashArray:"10",fillOpacity:.5};var i}function n(e){let t=e.properties.Dn;return 0===t||null==t?{fillOpacity:0,weight:0,opacity:0}:{fillColor:(i=t,i>.05?"#004d00":i>.01?"#006600":i>.005?"#008000":i>.001?"#00b300":i>5e-4?"#00cc00":i>1e-4?"#00e600":i>1e-5?"#33ff33":i>0?"#99ff99":"#FFEDA0"),weight:0,opacity:1,color:"CadetBlue",dashArray:"10",fillOpacity:.5};var i}function o(){return{color:"black",weight:1,opacity:.95}}function r(){return{color:"black",weight:1,opacity:.95}}function a(e,t){let i=[];for(let s of e){let e=turf.bbox(s),n={minX:e[0],minY:e[1],maxX:e[2],maxY:e[3]},o=t.search(n).map((e=>e.id));i=i.concat(o)}return i}let l=window["polyclip-ts"],h={nk_area:"./data/population_nk_processed_06w2_with_D.geojson",stockholm_area:"./data/population_stockholm.geojson",ockero_area:"./data/population_ockero.geojson",vastervik_area:"./data/population_vastervik.geojson"},d={nk_area:[58.5877,16.1924],stockholm_area:[59.3118,18.0663],ockero_area:[57.71,11.65],vastervik_area:[57.75,16.63]},u={nk_area:12,stockholm_area:11,ockero_area:12,vastervik_area:12};const p="Ground risk",g="Air risk",c='1st-party risk <span style="color: red; font-weight: bold;">(experimental)</span>';class m{static#K=1e-9;#Q;#H;#l;#ee;#te;#ie;#se;#ne;#oe;#re;#ae;#le;#he;#de;#ue;#x;#pe;#G;#ge;#ce;#me;#fe;#ye;#Le;#Ce;#Se;#be;#Ee;#Ae;#xe;#Me;#Be;#Ne;#_e;#ve;#De;#ke;#Ue;#we;#Pe;#Ie;#Te;#Fe;#J;#Re;#Ge;#Je;#Oe;#ze;#qe;constructor(e){this.#ze=e,this.#qe=h[e]??h.nk_area,console.log(this.#qe),this.#Q=200,this.#H=[],this.#l=[],this.#ee=L.layerGroup([]),this.#te=L.layerGroup([]),this.#se=null,this.#ne=null,this.#oe=L.layerGroup([]),this.#re=null,this.#ae=null,this.#le=L.layerGroup([]),this.#he=0,this.#de=0,this.#ue=0,this.#x=50,this.#pe=100,this.#G=8.34,this.#_e=1,this.#Te=.1,this.#ke=1,this.#Fe=1e3,this.#we=0,this.#Pe=0,this.#Ie=0,this.#ge=document.getElementById("population"),this.#ce=document.getElementById("length"),this.#me=document.getElementById("area"),this.#fe=document.getElementById("exposed-density"),this.#ye=document.getElementById("exposed-length-weight"),this.#Le=document.getElementById("nmac-rate"),this.#Ce=document.getElementById("totals-table"),this.#Se=document.getElementById("segments-table"),this.#be=document.getElementById("segment-extension"),this.#Ee=document.getElementById("spinner-container"),this.#J=null,this.#Re=null,this.#Ge=0,this.#Je=!0,this.#Oe=null,document.getElementById("currentYear").textContent=(new Date).getFullYear(),this.#He(),this.#je(),this.#We(),this.#Ye(),this.#Xe(),this.#Ze(),this.#$e(),this.#Ve(),this.#Ke(),this.#Qe(),this.#et(),this.#tt(),this.#it()}#st(e){}async#He(){let e=new Promise(((e,t)=>{$.getJSON(this.#qe,(function(i,s,n){"success"===s?e(i):t(error)}))}));try{this.#J=await e}catch(e){console.error("Error fetching data:",e)}if(this.#Je)try{this.#Oe=function(e){let t=new RBush,i=e.map(((e,t)=>{let i=e.geometry.coordinates[0][0];return{minX:i[0][0],minY:i[3][1],maxX:i[2][0],maxY:i[1][1],id:t}}));return t.load(i),t}(this.#J.features)}catch(e){console.error("Error creating R-Tree of the data:",e)}this.#Ie=this.#J.features.reduce(((e,t)=>e+(t.properties.Dn||0)),0),console.log("Total Dn sum:",this.#Ie)}async#je(){await this.#He();let e=L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:20,attribution:'&copy <a href="http://openstreetmap.org">OpenStreetMap</a> &copy; <a href="https://www.lantmateriet.se/en/">Lantmäteriet</a>'}),t=L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:20,attribution:'&copy <a href="http://openstreetmap.org">OpenStreetMap</a> &copy; <a href="https://www.lantmateriet.se/en/">Lantmäteriet</a>'}),o=L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:20,attribution:'&copy <a href="http://openstreetmap.org">OpenStreetMap</a> &copy; <a href="https://www.lantmateriet.se/en/">Lantmäteriet</a>'});this.#ie=L.map("map",{doubleClickZoom:!1,preferCanvas:!0,layers:[e]}).setView(d[this.#ze],u[this.#ze]),L.control.layers({[p]:e,[g]:t,[c]:o},null,{collapsed:!1}).addTo(this.#ie);let r=L.geoJSON(this.#J,{style:i}).addTo(this.#ie),a=L.geoJSON(this.#J,{style:s}),l=L.geoJSON(this.#J,{style:n});this.#oe.addTo(this.#ie),this.#ee.addTo(this.#ie),this.#te.addTo(this.#ie),this.#ie.on("baselayerchange",function(e){r.remove(),a.remove(),l.remove(),this.#oe.remove(),this.#le.remove(),this.#te.remove(),e.name===p?(r.addTo(this.#ie),this.#oe.addTo(this.#ie)):e.name===g?(a.addTo(this.#ie),this.#le.addTo(this.#ie)):e.name===c&&(l.addTo(this.#ie),this.#oe.addTo(this.#ie)),this.#te.addTo(this.#ie)}.bind(this)),this.#ie.on("dblclick",this.#nt.bind(this))}deinitializeMap(){null!=this.#ie&&this.#ie.remove()}#We(){[].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]')).map((function(e){return new bootstrap.Tooltip(e)}))}#nt(i){let s=this.#H.length>0?this.#H[this.#H.length-1].altitude:this.#Q,n=Object.values(i.latlng);const o=new e(n,s,this.#H.length);if(this.#ee.addLayer(o.marker),this.#ot(o),this.#H.length>0&&(this.#H[this.#H.length-1].nextCicle=o),this.#H.push(o),this.#H.length>1){let[e,i]=this.#H.slice(this.#H.length-2,this.#H.length),s=new t(e,i,e.altitude,this.#x,this.#l.length);this.#be.checked&&(s.extraLength=this.#pe,s.update()),this.#te.addLayer(s.polyline),this.#l.push(s),this.#rt("ground"),this.#rt("air"),this.#at([s])}}#ot(e){e.smoothCheckboxElement.addEventListener("change",(t=>{e.hasEdge()&&(this.#rt("ground"),this.#at([e.edge]))})),e.sliderElement.noUiSlider.on("change",((t,i)=>{this.#rt("ground"),e.hasEdge()&&2===e.edgesList.length&&e.edgesList[0].nodesList[0].isSmooth||!e.hasEdge()&&1===e.edgesList.length&&e.edgesList[0].nodesList[0].isSmooth?this.#at(e.edgesList):e.hasEdge()&&this.#at([e.edge])})),e.splitButtonElement.addEventListener("click",(()=>{this.#lt(e)})),e.removeButtonElement.addEventListener("click",(()=>{this.#ht(e)})),e.marker.on("moveend",(t=>{this.#rt("ground"),this.#rt("air"),this.#at(e.edgesList)}))}#lt(i){if(i.hasEdge()){let s=Object.values(i.edge.polyline.getCenter()),n=new e(s,i.altitude,i.positionInList+1),o=null,r=i.edge.nodesList[1];this.#ee.addLayer(n.marker),this.#ot(n),i.nextCicle=n,n.nextCicle=r,this.#H.splice(i.positionInList+1,0,n),i.edge.nodesList[1]=n,n.edgesList[0]=i.edge,i.edge.update(),1===r.edgesList.length?(r.edgesList.pop(),o=new t(n,r,n.altitude,this.#x,i.edge.positionInList+1)):2===r.edgesList.length&&(o=new t(n,r,n.altitude,this.#x,i.edge.positionInList+1),r.edgesList.reverse(),r.edgesList.pop()),this.#te.addLayer(o.polyline),this.#l.splice(i.edge.positionInList+1,0,o),this.#rt("ground"),this.#rt("air"),this.#at([i.edge,o]),this.#H.slice(i.positionInList+2,this.#H.length).map((e=>{e.positionInList+=1})),this.#l.slice(i.edge.positionInList+2,this.#l.length).map((e=>{e.positionInList+=1})),this.#l.slice(i.edge.positionInList,this.#l.length).map((e=>{this.#dt(e)}))}}#ht(e){if(e.hasEdge()&&1===e.edgesList.length)this.#H.splice(0,1),this.#ee.removeLayer(e.marker),this.#l.splice(0,1),this.#te.removeLayer(e.edge.polyline),this.#H[0].edgesList.splice(0,1),this.#H.map((e=>{e.positionInList-=1})),this.#l.map((e=>{e.positionInList-=1})),this.#Se.querySelector("tbody").deleteRow(0),this.#rt("ground"),this.#rt("air"),this.#ut([]),this.#l.map((e=>{this.#dt(e)}));else if(e.hasEdge()||1!==e.edgesList.length){if(2===e.edgesList.length){this.#H.splice(e.positionInList,1),this.#ee.removeLayer(e.marker),this.#l.splice(e.edge.positionInList,1),this.#te.removeLayer(e.edge.polyline),this.#Se.querySelector("tbody").deleteRow(e.edge.positionInList);let t=e.edgesList[0].nodesList[0],i=e.edge.nodesList[1];t.nextCycle=i,t.edge.nodesList[1]=i,i.edgesList[0]=t.edge,t.edge.update(),this.#H.slice(e.positionInList,this.#H.length).map((e=>{e.positionInList-=1})),this.#l.slice(e.edge.positionInList,this.#l.length).map((e=>{e.positionInList-=1})),this.#rt("ground"),this.#rt("air"),this.#at([t.edge]),this.#l.slice(e.edge.positionInList,this.#l.length).map((e=>{this.#dt(e)}))}}else{this.#H.splice(this.#H.length-1,1),this.#ee.removeLayer(e.marker),this.#l.splice(this.#l.length-1,1);let t=e.edgesList[0].nodesList[0];t.edge.polyline.remove(),t.edgesList.pop(),t.edge=null,t.nextCycle=null,this.#Se.querySelector("tbody").deleteRow(this.#l.length),this.#rt("ground"),this.#rt("air"),this.#ut([])}}#rt(e){"ground"===e&&null!=this.#ne?this.#oe.removeLayer(this.#ne):"air"===e&&null!=this.#ae&&this.#le.removeLayer(this.#ae);let t=this.#l.map((t=>"ground"===e?t.groundBuffer:t.airBuffer)),i=this.#pt(t);"ground"===e?(this.#se=i,this.#ne=L.geoJSON(i,{style:o}),this.#oe.addLayer(this.#ne)):"air"===e&&(this.#re=i,this.#ae=L.geoJSON(i,{style:r}),this.#le.addLayer(this.#ae))}#pt(e){let t=this.#H.map((e=>Object.values(e.point.geometry.coordinates.toReversed())));if(console.log("nodesCoordinates: ",JSON.stringify(t,null,2)),this.#l.length>0){let t=l.union(...e.map((e=>e.geometry.coordinates)));return turf.buffer(turf.multiPolygon(t),1e-4,{units:"meters"})}return null}#ut(e){clearTimeout(this.#Re),this.#Re=setTimeout((()=>{this.#at(e)}),1e3)}async#at(e){if(await this.#He(),this.#se){this.#Ge<1&&this.#gt(),this.#Ge++,this.#he=0,e.map((e=>{e.population=0}));let t=null;if(this.#Je){let i=a(e.map((e=>e.groundBuffer)),this.#Oe),s=a(e.map((e=>e.airBuffer)),this.#Oe);t=Array.from(new Set(i.concat(s))).map((e=>this.#J.features[e]))}else t=this.#J.features;let i=t.length>1e3?4:1,s=Math.ceil(t.length/i),n=[],o=[],r=[],l=[],h=[],d=[],u=[],p=1e4;for(let a=0;a<i;a++){let g=a*s,c=g+s,m=t.slice(g,c),f=new Worker("./src/workers.js"),y=e.map((e=>e.groundBuffer)),L=e.map((e=>e.airBuffer)),C=e.map((e=>{let[t,i]=e.nodesList;return[t.circleCoveredPopulation,i.circleCoveredPopulation]=[0,0],[t.circle,i.circle]}));f.postMessage([m,y,L,C,p]),f.onmessage=function(t){let[s,a,g,c,m,f]=t.data;if(o.push(s),r.push(a),l.push(g),h.push(c),d.push(m),u.push(f),o.length===i){for(let t=0;t<e.length;t++){let i=e[t];i.population=o.map((e=>e[t])).reduce(((e,t)=>e+t),0),i.maxSquarePopulationDensity=Math.max(...d.map((e=>e[t])))/p;let s=r.map((e=>e[t])),n=s.reduce(((e,t)=>e.map(((e,i)=>e+t[i])))),[a,g]=i.nodesList;a.circleCoveredPopulation=n[0],g.circleCoveredPopulation=n[1];let c=l.map((e=>e[t])).reduce(((e,t)=>e+t),0);i.NMAC_time=c;let m=h.map((e=>e[t]));m=m.flat().filter((e=>e>0)),i.NMAC_avg_speeds=m;let f=m.reduce(((e,t)=>e+t),0)/m.length||0,y=this.#J.features[0].properties.p;i.computeNMAC_rate(c,f,y);let L=u.map((e=>e[t])).reduce(((e,t)=>e+t),0),C=this.#Ie>0?L/this.#Ie:0;i.firstPartyDn=C,i.computeFirstPartyNMAC_rate(C*this.#_e,this.#G,y)}let t=this.#l.reduce((function(e,t){return e.concat(t.NMAC_avg_speeds)}),[]).flat(),i=t.length>0?t.reduce(((e,t)=>e+t),0)/t.length:0,s=this.#l.reduce(((e,t)=>e+t.airBufferArea),0),a=this.#l.reduce(((e,t)=>e+t.NMAC_time),0),g=2*this.#x**2*a*Math.sqrt(this.#G**2+i**2)/(this.#x*s)*this.#J.features[0].properties.p,c=this.#l.reduce(((e,t)=>e+t.length),0);this.#de=c/this.#G*g,this.#ue=c/this.#G,this.#he=Math.ceil(3600*g*1e6);let m=this.#l.reduce(((e,t)=>e+(t.firstPartyDn||0)),0),f=2*this.#x**2*m*this.#_e*Math.sqrt(2*this.#G**2)/(this.#x*s)*this.#J.features[0].properties.p;this.#Pe=c/this.#G*f,this.#we=Math.ceil(3600*f*1e6),this.#Ge--,this.#it(),e.map((e=>{this.#dt(e)})),n.forEach((function(e){e.terminate()}))}}.bind(this),n.push(f)}}}#gt(){this.#Ee.style.display="block";let e=this.#Ce.querySelector("tbody").querySelector("tr").querySelectorAll("td");for(let t of e)t.innerHTML='<div class="spinner-grow spinner-grow-sm text-primary" role="status"></div>'}#ct(){this.#Ee.style.display="none"}#mt(){let e=0,t=0;for(let i=0;i<this.#l.length-1;i++){let s=this.#l[i],n=this.#l[i+1];e+=Math.min(s.nodesList[1].circleCoveredPopulation,n.nodesList[0].circleCoveredPopulation),t+=Math.min(s.nodesList[1].circleArea,n.nodesList[0].circleArea)}return[e,t]}#it(){let e=this.#l.reduce(((e,t)=>e+t.population),0),t=this.#l.reduce(((e,t)=>e+t.length),0),i=this.#l.reduce(((e,t)=>e+t.groundArea),0),[s,n]=this.#mt();e-=s,i-=n;let o=this.#ft(),r=o.toExponential(2),a=i?(e/i).toExponential(2):0,l=this.#l.reduce(((e,t)=>Math.max(e,t.maxSquarePopulationDensity)),0),h=i?this.#de.toExponential(2):0,d=i?this.#Pe.toExponential(2):0,u=this.#ue,p=this.#Ce.querySelector("tbody").querySelector("tr").querySelectorAll("td"),g=[Math.ceil(t),Math.ceil(u/60),Math.ceil(e),Math.ceil(i),r,a,l,this.#he,h,this.#we,d];if(this.#Ge<1){for(let e=0;e<p.length;e++)p[e].textContent=g[e];this.#yt(p[4],o),this.#ct()}}#dt(e){let t=this.#Se.querySelector("tbody"),i=t.querySelectorAll("tr"),s=[e.positionInList+1,e.altitude,Math.ceil(e.length),Math.ceil(e.length/this.#G/60)],n=this.#Lt(e),o=[Math.ceil(e.population),Math.ceil(e.groundArea),n.toExponential(2),(e.population/e.groundArea).toExponential(2),e.maxSquarePopulationDensity.toExponential(2)],r=[Math.ceil(e.NMAC_rate),e.expectedNMAC.toExponential(2)],a=[Math.ceil(e.firstPartyNMAC_rate||0),(e.expectedFirstPartyNMAC||0).toExponential(2)],l=s.concat(o,r,a);if(this.#l.length===i.length){let t=i[e.positionInList].querySelectorAll("td");for(let e=0;e<l.length;e++)t[e+1].textContent=l[e];t[0].style.background=e.polylineColor,this.#yt(t[7],n)}else{let i=document.createElement("tr"),l=document.createElement("td");l.classList.add("color-column"),l.style.background=e.polylineColor,i.appendChild(l),this.#Ct(i,s,"table-light"),this.#Ct(i,o,"table-warning"),this.#Ct(i,r,"table-primary"),this.#Ct(i,a,"table-success");let h=i.querySelectorAll("td");this.#yt(h[7],n),t.appendChild(i)}}#Ct(e,t,i){for(let s=0;s<t.length;s++){const n=document.createElement("td");n.classList.add(i),n.textContent=t[s],e.appendChild(n)}}#yt(e,t){e&&(e.style.color=t<m.#K?"green":"red")}#St(){let e=this.#ke/2;return Math.PI*e*e}#Lt(e){return this.#Fe&&e.groundArea?this.#Te/this.#Fe*e.population*(this.#St()/e.groundArea):0}#ft(){if(!this.#Fe)return 0;let e=this.#St(),t=this.#l.reduce(((t,i)=>t+(i.groundArea?i.population*e/i.groundArea:0)),0);return this.#Te/this.#Fe*t}#Ye(){this.#Ae=document.getElementById("nmac-slider"),this.#Ae.noUiSlider||noUiSlider.create(this.#Ae,{start:[this.#x],step:1,connect:"lower",tooltips:{to:e=>Math.round(e)},range:{min:[10],max:[1200]}}),this.#Ae.noUiSlider.on("change",this.#bt.bind(this))}#bt(e,t){this.#x=Math.floor(e[t]);for(let e of this.#l)e.NMAC_radius=this.#x,e.update();this.#rt("air"),this.#ut(this.#l)}#Xe(){this.#Me=document.getElementById("extension-slider"),this.#Me.noUiSlider||noUiSlider.create(this.#Me,{start:[this.#pe],step:1,tooltips:{to:e=>Math.round(e)},connect:"lower",range:{min:[0],max:[1200]}}),this.#Me.noUiSlider.on("change",this.#Et.bind(this)),this.#Me.noUiSlider.disable()}#Et(e,t){this.#pe=Math.floor(e[t]),!this.#be.checked||this.#At()}#Ze(){this.#xe=document.getElementById("uav-speed-slider"),this.#xe.noUiSlider||noUiSlider.create(this.#xe,{start:[this.#G],step:.1,tooltips:{to:e=>Math.round(60*e*60/1e3)},connect:"lower",range:{min:[1],max:[50]}}),this.#xe.noUiSlider.on("change",this.#xt.bind(this))}#xt(e,t){this.#G=e[t],this.#l.map((e=>{e.v_UA=this.#G})),this.#ut(this.#l)}#$e(){this.#Be=document.getElementById("global-altitude-slider"),this.#Be.noUiSlider||noUiSlider.create(this.#Be,{start:[this.#Q],step:1,tooltips:{to:e=>Math.round(e)},connect:"lower",range:{min:[10],max:[1200]}}),this.#Be.noUiSlider.on("change",this.#Mt.bind(this))}#Qe(){this.#Ne=document.getElementById("drone-density-slider"),this.#Ne.noUiSlider||noUiSlider.create(this.#Ne,{start:[this.#_e],step:1,tooltips:{to:e=>Math.round(e)},connect:"lower",range:{min:[1],max:[100]}}),this.#Ne.noUiSlider.on("change",this.#Bt.bind(this))}#Ve(){this.#ve=document.getElementById("fatality-probability-slider"),this.#ve.noUiSlider||noUiSlider.create(this.#ve,{start:[this.#Te],step:.01,tooltips:{to:e=>Number(e).toFixed(2)},connect:"lower",range:{min:[0],max:[1]}}),this.#ve.noUiSlider.on("change",this.#Nt.bind(this))}#Nt(e,t){this.#Te=Number(e[t]),this.#it(),this.#l.map((e=>{this.#dt(e)}))}#Ke(){this.#Ue=document.getElementById("mtbf-input"),this.#Ue&&(this.#Ue.value=this.#Fe,this.#Ue.addEventListener("input",this.#_t.bind(this)))}#_t(e){let t=Number(e.target.value);this.#Fe=Number.isFinite(t)&&t>0?t:0,this.#it(),this.#l.map((e=>{this.#dt(e)}))}#Bt(e,t){this.#_e=Math.floor(e[t]),this.#ut(this.#l)}#et(){this.#De=document.getElementById("drone-dimension-slider"),this.#De.noUiSlider||noUiSlider.create(this.#De,{start:[this.#ke],step:.01,tooltips:{to:e=>Number(e).toFixed(2)},connect:"lower",range:{min:[.1],max:[5]}}),this.#De.noUiSlider.on("change",this.#vt.bind(this))}#vt(e,t){this.#ke=Number(e[t]),this.#it(),this.#l.map((e=>{this.#dt(e)}))}#Mt(e,t){let i=e[t],s=[];for(let e of this.#l)e.altitudeManuallyChanged||(e.altitude=Math.floor(i),e.nodesList[0].altitudeUpdatedGlobally(i),s.push(e));s.map((e=>e.update()));let n=this.#l[this.#l.length-1];n.altitudeManuallyChanged||(n.nodesList[1].altitudeUpdatedGlobally(i),n.update()),this.#rt("ground"),this.#ut(s)}#tt(){this.#be.addEventListener("change",this.#At.bind(this))}#At(e){let t=0;this.#be.checked?(t=this.#pe,this.#Me.noUiSlider.enable()):this.#Me.noUiSlider.disable(),this.#l.map((e=>{e.extraLength=t})),this.#l.map((e=>e.update())),this.#rt("ground"),this.#rt("air"),this.#ut(this.#l)}}!function(){let e=new m("nk_area");$(document).ready((function(){$('input[name="area_switcher"]').on("change",(function(){e.deinitializeMap(),e=new m(this.id)}))}))}()})();